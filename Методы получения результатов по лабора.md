# Методы получения результатов по лабораториям

## 1. Лаборатории с результатами через FTP

Для повторного получения файла результатов достаточно попросить лабораторию о перевыгрузке. На стороне ЛП дополнительные манипуляции не нужны.

**Список лабораторий:**
- Хеликс
- Инвитро
- ЦМД
- КДЛ
- НЦКМД
- СЗЦДМ
- ЦЛТ АБВ

---

## 2. Лаборатории через веб-сервис

### 2.1. Альфалаб (AlfaLab.dll)

**Лаборатории:**
- Архимед (ЛП)
- ДНКОМ (ЛП)
- ДНКОМ Covid (ЛП)
- Диалаб (ЛП)
- Диалаб Covid (ЛП)
- Диалаб ПМО (ЛП)
- ЕМЛ (ЛП)
- Лабквест (ЛП)
- Лаборатория.ру (ЛП)
- Литех ЛИС (ЛП)
- МобилМед (ЛП)
- Санатест (ЛП)
- Скайлаб (ЛП)
- Хромолаб (ЛП)
- ЭндоМедЛаб (ЛП)
- Эфис (ЛП)

**Процесс:**
Отправляется запрос к очереди на выгрузку результатов с временной меткой, например `Date="13.08.2025 00:10:02"`. Если на указанную дату есть данные, система возвращает результат. Временная метка автоматически обновляется до текущего времени при запросе.
```
<?xml version="1.0" encoding="Windows-1251"?>
<Message 
  MessageType="query-next-referral-results" 
  Date="13.08.2025 00:10:02" 
  Sender="" 
  Receiver="LabQuest" 
  Password=""
/>
``` 
После получения результата мы отправляем подтверждение, чтобы удалить его из очереди. Для повторного получения лаборатория должна повторно добавить результат в очередь

---

### 2.2. InterSystemsLab.dll
**Лаборатории:**
- РЖД КРД (ЛП)
- РЖД МСК (ЛП)
- РЖД НН (ЛП)
- РЖД НН ТЕСТ!
- РЖД СТЕР (ЛП)
- РЖД Уфа (ЛП)
- РЖД Чита (ЛП)
- РЖД Чита ТЕСТ!
- Смартлаб (ЛП)

**Процесс:**
Пример запроса :
```
Request: { "resourceType": "Parameters", "parameter": [   {    "name": "start",    "valueDateTime": "2025-08-12T20:59:42Z"   },  
 {    "name": "end",    "valueDateTime": "2025-08-12T21:00:09Z"   },   {    "name": "requesterOrganization",  
  "valueIdentifier": {      "system": "urn:Organization",      "value": ""     }   } ] }
``` 

  Где `{    "name": "start",    "valueDateTime": "2025-08-12T20:59:42Z"   }` дата берется из `filial_contr_links.LSSTARTDATE`, а
  `{    "name": "end",    "valueDateTime": "2025-08-12T21:00:09Z"   }` является текущей датой на момент запроса.
  После запроса дату обновляем на текущую в `LSSTARTDATE`

  При успешном получении результата отправляем подтверждение о получении.

  Обычно со своей стороны манипуляции не нужны, и достаточно попросить перевыгрузить у лаборатории. Но на крайний случай можно изменить дату в `LSSTARTDATE`, тогда повторно получим все результаты, которые были в это время. У них это не совсем очередь, и результаты оттуда не пропадают после получения. 

---

### 2.3. CityLab_msk.dll
**Лаборатории:**
- Ситилаб ЕКБ (ЛП)
- Ситилаб КЗН (ЛП)
- Ситилаб МСК (ЛП)
- Ситилаб НСБ (ЛП)
- Ситилаб РнД (ЛП)
- Ситилаб СМР (ЛП)
- Ситилаб СПБ (ЛП)
- Ситилаб ТМН (ЛП)

**Процесс:**
По Ситилабу используется несколько методов для получения результатов. `RC_GetInquiriesJournal` - это запрос на получение списка заказов, по которым были изменения на указанную дату в запросе.
Пример:
```
<?xml version="1.0" encoding="Windows-1251"?> 
<content> <e n="login" v="" t="string" /> <e n="password" v="" t="string" /> <e n="Timestamp" v="1755025802" t="datetime" /> </content>
```

Где `n="Timestamp" v="1755025802"` - это дата из `filial_contr_links.LSSTARTDATE`, она обновляется раз в час.

Потом второй метод `RC_GetInquiryAuth`: здесь уже идет сравнение `LastWorkResultDate` из XML с `TREAT.LISTIMESTAMP`. И только если `LastWorkResultDate` > даты в `treat`, то мы его загрузим.

`InternalNum "132278390" LastWorkResultDate 13.08.2025 10:36:32 TREAT.LISTIMESTAMP 13.08.2025 10:28:15 Наряд не закрыт 1`
```
13.08.2025 10:41:14 Запрашиваем детальную информацию RC_GetInquiryAuth :
 <?xml version="1.0" encoding="Windows-1251"?> 
<content> <e n="login" v="" t="string" /> <e n="password" v="" t="string" /> <e n="requestId" v="" t="string" /> </content>
```

Поэтому для повторного получения результатов нужно:
1. Попросить в лаборатории обновить штамп (чтобы заказ попал в метод `RC_GetInquiriesJournal`)
2. В таблице `TREAT` удалить дату в `LISTIMESTAMP`, чтобы мы смогли его скачать

---

### Остальные лаборатории

**LisInfoclinica.dll:**
- ДаВинчиЛаб (ЛП)
- РДЛ (ЛП)

**Morfolab.dll:**
- Морфолаб (ЛП)

**Litex.dll:**
- Литех (ЛП)

**bion.dll:**
- БИОН (ЛП)

**Gemotest_soap.dll:**
- Гемотест SOAP (ЛП)

**GemoHelp.dll:**
- Гемохелп (ЛП)

**innovasystems.dll:**
- ДНК-Диагностика (ЛП)

**dcli.dll:**
- ДЦЛИ (ЛП) (2 записи)

**LisNacph.dll:**
- НАКФФ (ЛП)

**UnimLab.dll:**
- РЖД ЦПАЦ (ЛП)
```
